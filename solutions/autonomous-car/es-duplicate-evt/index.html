<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://jeromeboyer.net/eda-studies/solutions/autonomous-car/es-duplicate-evt/ rel=canonical><link href=../../../techno/mirrormaker/ rel=prev><link href=../../../ibm-assets/ rel=next><link rel=icon href=../../../images/logo-blue.drawio.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.14"><title>AWS duplicate with EB - Event-Driven Solutions in Hybrid Cloud - Jerome Boyer</title><link rel=stylesheet href=../../../assets/stylesheets/main.342714a4.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#handle-duplicate-delivery-with-aws-eventbridge class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="Event-Driven Solutions in Hybrid Cloud - Jerome Boyer" class="md-header__button md-logo" aria-label="Event-Driven Solutions in Hybrid Cloud - Jerome Boyer" data-md-component=logo> <img src=../../../images/logo.drawio.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Event-Driven Solutions in Hybrid Cloud - Jerome Boyer </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> AWS duplicate with EB </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/eda-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../concepts/eda/ class=md-tabs__link> EDA concepts </a> </li> <li class=md-tabs__item> <a href=../../../methodology/event-storming/ class=md-tabs__link> Methodology </a> </li> <li class=md-tabs__item> <a href=../../../patterns/ class=md-tabs__link> Design patterns </a> </li> <li class=md-tabs__item> <a href=../../../methodology/getting-started/ class=md-tabs__link> Demonstrations </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../techno/kafka/ class=md-tabs__link> Technologies </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Event-Driven Solutions in Hybrid Cloud - Jerome Boyer" class="md-nav__button md-logo" aria-label="Event-Driven Solutions in Hybrid Cloud - Jerome Boyer" data-md-component=logo> <img src=../../../images/logo.drawio.png alt=logo> </a> Event-Driven Solutions in Hybrid Cloud - Jerome Boyer </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/eda-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> EDA concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> EDA concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../concepts/eda/ class=md-nav__link> <span class=md-ellipsis> Reference architecture </span> </a> </li> <li class=md-nav__item> <a href=../../../concepts/soa-eda/ class=md-nav__link> <span class=md-ellipsis> From SOA to EDA </span> </a> </li> <li class=md-nav__item> <a href=../../../concepts/backbone/ class=md-nav__link> <span class=md-ellipsis> Messaging backbone </span> </a> </li> <li class=md-nav__item> <a href=../../../concepts/legacy-itg/ class=md-nav__link> <span class=md-ellipsis> Legacy integration </span> </a> </li> <li class=md-nav__item> <a href=../../../concepts/data-pipeline/ class=md-nav__link> <span class=md-ellipsis> Data pipeline </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Methodology </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Methodology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../methodology/event-storming/ class=md-nav__link> <span class=md-ellipsis> Event Storming </span> </a> </li> <li class=md-nav__item> <a href=../../../methodology/ddd/ class=md-nav__link> <span class=md-ellipsis> Domain driven design </span> </a> </li> <li class=md-nav__item> <a href=../../../methodology/ddd/eda_assessment/ class=md-nav__link> <span class=md-ellipsis> EDA Assessment </span> </a> </li> <li class=md-nav__item> <a href=../../../methodology/event-storming/vaccine-dt-es-ddd/ class=md-nav__link> <span class=md-ellipsis> Vaccine Examples </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Design patterns </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Design patterns </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../patterns/ class=md-nav__link> <span class=md-ellipsis> Common patterns </span> </a> </li> <li class=md-nav__item> <a href=../../../patterns/events-versus-messages/ class=md-nav__link> <span class=md-ellipsis> Messaging vs events </span> </a> </li> <li class=md-nav__item> <a href=../../../patterns/model/ class=md-nav__link> <span class=md-ellipsis> Devising the data models </span> </a> </li> <li class=md-nav__item> <a href=../../../patterns/api-mgt/ class=md-nav__link> <span class=md-ellipsis> API management </span> </a> </li> <li class=md-nav__item> <a href=../../../patterns/saga/ class=md-nav__link> <span class=md-ellipsis> Saga </span> </a> </li> <li class=md-nav__item> <a href=../../../patterns/event-sourcing/ class=md-nav__link> <span class=md-ellipsis> Event Sourcing </span> </a> </li> <li class=md-nav__item> <a href=../../../patterns/cqrs/ class=md-nav__link> <span class=md-ellipsis> CQRS </span> </a> </li> <li class=md-nav__item> <a href=../../../patterns/reactive/ class=md-nav__link> <span class=md-ellipsis> Reactive </span> </a> </li> <li class=md-nav__item> <a href=../../../patterns/flow-architectures/ class=md-nav__link> <span class=md-ellipsis> Flow architecture </span> </a> </li> <li class=md-nav__item> <a href=../../../patterns/dlq/ class=md-nav__link> <span class=md-ellipsis> Dead letter queue </span> </a> </li> <li class=md-nav__item> <a href=../../../patterns/data-lineage/ class=md-nav__link> <span class=md-ellipsis> Data lineage </span> </a> </li> <li class=md-nav__item> <a href=../../../patterns/governance/ class=md-nav__link> <span class=md-ellipsis> Governance </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Demonstrations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Demonstrations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../methodology/getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> </a> </li> <li class=md-nav__item> <a href=../../../techno/kafka/playground/ class=md-nav__link> <span class=md-ellipsis> Sandbox notes </span> </a> </li> <li class=md-nav__item> <a href=../../gitops_IaC/ class=md-nav__link> <span class=md-ellipsis> GitOps - IaC </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/eda-rt-inventory/ class=md-nav__link> <span class=md-ellipsis> Real-time Inventory </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6 checked> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> Technologies </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=true> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Technologies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../techno/kafka/ class=md-nav__link> <span class=md-ellipsis> Kafka </span> </a> </li> <li class=md-nav__item> <a href=../../../techno/kafka/faq/ class=md-nav__link> <span class=md-ellipsis> Kafka FAQ </span> </a> </li> <li class=md-nav__item> <a href=../../../techno/kafka/producer/ class=md-nav__link> <span class=md-ellipsis> Kafka Producer </span> </a> </li> <li class=md-nav__item> <a href=../../../techno/kafka/consumer/ class=md-nav__link> <span class=md-ellipsis> Kafka Consumer </span> </a> </li> <li class=md-nav__item> <a href=../../../techno/kafka/security/ class=md-nav__link> <span class=md-ellipsis> Kafka Security </span> </a> </li> <li class=md-nav__item> <a href=../../../techno/avro-schemas/ class=md-nav__link> <span class=md-ellipsis> Schema Mgt </span> </a> </li> <li class=md-nav__item> <a href=../../../techno/kstreams/ class=md-nav__link> <span class=md-ellipsis> Kafka Streams </span> </a> </li> <li class=md-nav__item> <a href=../../../techno/kafka-connect/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect </span> </a> </li> <li class=md-nav__item> <a href=../../../techno/confluent/ class=md-nav__link> <span class=md-ellipsis> Confluent </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/redpanda-studies/ class=md-nav__link> <span class=md-ellipsis> RedPanda </span> </a> </li> <li class=md-nav__item> <a href=../../../techno/mirrormaker/ class=md-nav__link> <span class=md-ellipsis> Mirror Maker 2 </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/flink-studies class=md-nav__link> <span class=md-ellipsis> Flink </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study/activemq/ class=md-nav__link> <span class=md-ellipsis> Active MQ </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study/rabbitmq/ class=md-nav__link> <span class=md-ellipsis> Rabbit MQ </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> AWS duplicate with EB </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> AWS duplicate with EB </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#focus-on-producer-processing class=md-nav__link> <span class=md-ellipsis> Focus on producer processing </span> </a> </li> <li class=md-nav__item> <a href=#the-consumer-part class=md-nav__link> <span class=md-ellipsis> The Consumer part </span> </a> <nav class=md-nav aria-label="The Consumer part"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#dynamodb-backend class=md-nav__link> <span class=md-ellipsis> DynamoDB backend </span> </a> </li> <li class=md-nav__item> <a href=#demonstrate-with-a-simulator class=md-nav__link> <span class=md-ellipsis> Demonstrate with a simulator </span> </a> </li> <li class=md-nav__item> <a href=#single-application-instance class=md-nav__link> <span class=md-ellipsis> Single application instance: </span> </a> </li> <li class=md-nav__item> <a href=#using-caching-with-redis class=md-nav__link> <span class=md-ellipsis> Using Caching with Redis </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#alternates class=md-nav__link> <span class=md-ellipsis> Alternates </span> </a> <nav class=md-nav aria-label=Alternates> <ul class=md-nav__list> <li class=md-nav__item> <a href=#powertool-for-aws-lambda class=md-nav__link> <span class=md-ellipsis> Powertool for AWS Lambda </span> </a> </li> <li class=md-nav__item> <a href=#use-outbox-pattern class=md-nav__link> <span class=md-ellipsis> Use Outbox pattern </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/yarfba/kinesis class=md-nav__link> <span class=md-ellipsis> AWS Kinesis </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/yarfba/serverless/msk class=md-nav__link> <span class=md-ellipsis> AWS MSK </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study class=md-nav__link> <span class=md-ellipsis> AWS messaging </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study/sqs/ class=md-nav__link> <span class=md-ellipsis> AWS SQS </span> </a> </li> <li class=md-nav__item> <a href=../../../ibm-assets/ class=md-nav__link> <span class=md-ellipsis> IBM Assets </span> </a> </li> <li class=md-nav__item> <a href=../../../techno/ibm-mq/ class=md-nav__link> <span class=md-ellipsis> IBM MQ </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#focus-on-producer-processing class=md-nav__link> <span class=md-ellipsis> Focus on producer processing </span> </a> </li> <li class=md-nav__item> <a href=#the-consumer-part class=md-nav__link> <span class=md-ellipsis> The Consumer part </span> </a> <nav class=md-nav aria-label="The Consumer part"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#dynamodb-backend class=md-nav__link> <span class=md-ellipsis> DynamoDB backend </span> </a> </li> <li class=md-nav__item> <a href=#demonstrate-with-a-simulator class=md-nav__link> <span class=md-ellipsis> Demonstrate with a simulator </span> </a> </li> <li class=md-nav__item> <a href=#single-application-instance class=md-nav__link> <span class=md-ellipsis> Single application instance: </span> </a> </li> <li class=md-nav__item> <a href=#using-caching-with-redis class=md-nav__link> <span class=md-ellipsis> Using Caching with Redis </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#alternates class=md-nav__link> <span class=md-ellipsis> Alternates </span> </a> <nav class=md-nav aria-label=Alternates> <ul class=md-nav__list> <li class=md-nav__item> <a href=#powertool-for-aws-lambda class=md-nav__link> <span class=md-ellipsis> Powertool for AWS Lambda </span> </a> </li> <li class=md-nav__item> <a href=#use-outbox-pattern class=md-nav__link> <span class=md-ellipsis> Use Outbox pattern </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=handle-duplicate-delivery-with-aws-eventbridge>Handle duplicate delivery with AWS EventBridge<a class=headerlink href=#handle-duplicate-delivery-with-aws-eventbridge title="Permanent link">&para;</a></h1> <p><strong>Problem statement</strong>: how to handle duplicate records when using AWS EventBridge as event backbone?. </p> <p>This is a common problem in many messaging systems, where producer retries can generates the same message multiple times or consumer retries on the subscribed topic, may generate duplicate processing of the received message. </p> <p>Producer retries because it did not received an acknowledge message from the receiver (which in our case is EventBridge), may be due to network failure. </p> <p>The following diagram presents the potential problem. The left lambda function exposes an API to create "CarRide" entity and then to send message to Event Bus that the CarRide was created. The same applies if the CarRide is updated, like for example, the customer accepts the proposed deal so a autonomous car can be dispatched:</p> <p><img alt src=../diagrams/eb-duplicate-problem.drawio.png width=900></p> <p>EventBridge is not a technology where the broker supports a protocol to avoid duplication, like Kafka does with the idempotence configuration for producer. So producer may generate duplicates. As we will see in producer section below, we can add event id specific to the application to trace duplicate records end to end (we use idempotencyID which has no business meaning, in real life it may be relevant to do a combined key with busines transaction ID). If the producer timeout after not receiving the acknowledge, it will send the message again. If the returned answer from EventBridge includes errors, the only things that can be done in producer code is to send messages not processed by the Event Bus to a Dead Letter Queue. </p> <p>As duplicates will exist, we need to have consumers supporting idempotency. As Woolf and Hohpe wrote in their "Enterprise Integration Patterns book" , supporting <strong>idempotency</strong> is to be able to process a message with the same effect, whether it is received once or multiple times.</p> <p>Also remember that in a pure EDA point of view, consumer can be added, as subscribers, over time to address new use cases. Producers should not be aware of those consumers, they just publish events as their internal business entity state changes. </p> <p>Amazon <a href=https://docs.aws.amazon.com/eventbridge/latest/userguid>EventBridge</a> has the following important characteristics that we can leverage to address de-duplication:</p> <ul> <li>Routing rules to filter or fan-out to a limited set of targets.</li> <li>Message Persistence with possible replays.</li> <li>Event replications to event bus in another region.</li> <li>Pipes to do point to point integration between source and destination.</li> </ul> <h2 id=focus-on-producer-processing>Focus on producer processing<a class=headerlink href=#focus-on-producer-processing title="Permanent link">&para;</a></h2> <p>Producer to EventBridge may generate duplicate messages while retrying to send a message because of communication issue or not receiving an acknowledgement response. The producer code needs to take into account connection failure, and manage retries.</p> <p>The SDK for EventBridge includes a method called <a href=https://docs.aws.amazon.com/eventbridge/latest/APIReference/API_PutEvents.html>put_events</a> to send 1 to 10 events to a given Event Bus URL. Each record sent includes an envelop with the following structure:</p> <div class="language-json highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=nt>&quot;Entries&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=w>    </span><span class=p>{</span><span class=w> </span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>    </span><span class=nt>&quot;Source&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;reference of the producer&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>    </span><span class=nt>&quot;Resources&quot;</span><span class=p>:</span><span class=w> </span><span class=nt>&quot;aws ARN of the producer app&quot;</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>    </span><span class=nt>&quot;DetailType&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;CarRideEventType&quot;</span><span class=p>,</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=w>    </span><span class=nt>&quot;Time&quot;</span><span class=p>:</span><span class=w> </span><span class=err>da</span><span class=kc>tet</span><span class=err>ime.</span><span class=kc>t</span><span class=err>oday().s</span><span class=kc>trft</span><span class=err>ime(&#39;%Y</span><span class=mi>-</span><span class=err>%m</span><span class=mi>-</span><span class=err>%d&#39;)</span><span class=p>,</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=w>    </span><span class=nt>&quot;Detail&quot;</span><span class=p>:</span><span class=w> </span><span class=err>da</span><span class=kc>ta</span><span class=p>,</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=w>    </span><span class=nt>&quot;EventBusName&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>tar</span><span class=err>ge</span><span class=kc>t</span><span class=err>Bus</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=p>]</span>
</span></code></pre></div> <p>The message is, in fact, including more parameters as a set of <a href=https://docs.aws.amazon.com/eventbridge/latest/APIReference/CommonParameters.html>common parameters</a> are defined for each different EventBridge API mostly for versioning and security token. </p> <p>A EventBridge's response Entries array can include both successful and unsuccessful entries.</p> <p>The returned response includes an event <code>Id</code> (created by EventBridge) for each entry sent processed successfully, or an error object with code and message: </p> <div class="language-json highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=p>[</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>    </span><span class=p>{</span><span class=w> </span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>         </span><span class=nt>&quot;ErrorCode&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;string&quot;</span><span class=p>,</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>         </span><span class=nt>&quot;ErrorMessage&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;string&quot;</span><span class=p>,</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>    </span><span class=p>},</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>    </span><span class=p>{</span><span class=w>  </span><span class=nt>&quot;EventId&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;string&quot;</span><span class=w> </span><span class=p>}</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=p>]</span>
</span></code></pre></div> <p>As for each record, the index of the response element is the same as the index in the Entries array, it is then possible to identify the message in error and to resend it or to move it to a Dead Letter Queue. </p> <p>There are some errors reported that are due to the EventBridge service, like a <code>ThrottlingException</code> or <code>InternalFailure</code> that may be retried. Other errors should never be retried but message sent to a DLD queue or saved in a temporary storage for future processing. </p> <p>To better support an EDA approach, we need to assign a unique idempotency identifier to each message, with a sequencer and track the processed messages using this identifier and the current count. We should not leverage the eventID created by the event bus, as it is local to this bus, and we may need to go over other components or even another event bus in another region. Also this eventId is not idempotent.</p> <p>Here is an example of payload creation in python, with the idempotencyId (the one from the producer point of view and not the EventBridge created one) as part of the <code>attributes</code> element (the metadata part of <a href=https://cloudevents.io>CloudEvents.io</a>): </p> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>def</span><span class=w> </span><span class=nf>defineCloudEvent</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>    <span class=n>attributes</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>        <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;acme.acr.CarRiderCreatedEvent&quot;</span><span class=p>,</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>        <span class=s2>&quot;source&quot;</span><span class=p>:</span> <span class=s2>&quot;acr.com.car-ride-simulator&quot;</span><span class=p>,</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>        <span class=s2>&quot;idempotencyId&quot;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid1</span><span class=p>()),</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>        <span class=s2>&quot;eventTime&quot;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>today</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1> %H:%M:%S.</span><span class=si>%f</span><span class=s1>&#39;</span><span class=p>),</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>        <span class=s2>&quot;eventCount&quot;</span><span class=p>:</span> <span class=mi>1</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>    <span class=p>}</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>    <span class=n>cloudEventToSend</span> <span class=o>=</span> <span class=p>{</span> <span class=s2>&quot;attributes&quot;</span><span class=p>:</span> <span class=n>attributes</span><span class=p>,</span> <span class=s2>&quot;data&quot;</span><span class=p>:</span> <span class=n>data</span><span class=p>}</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>    <span class=n>entries</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>                <span class=p>{</span> <span class=s2>&quot;Source&quot;</span><span class=p>:</span> <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;source&quot;</span><span class=p>],</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>                <span class=s2>&quot;DetailType&quot;</span><span class=p>:</span> <span class=s2>&quot;CarRideEvent&quot;</span><span class=p>,</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a>                <span class=s2>&quot;Time&quot;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>today</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y-%m-</span><span class=si>%d</span><span class=s1>&#39;</span><span class=p>),</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>                <span class=s2>&quot;Detail&quot;</span><span class=p>:</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>cloudEventToSend</span><span class=p>),</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a>                <span class=s2>&quot;EventBusName&quot;</span><span class=p>:</span> <span class=n>targetBus</span><span class=p>,</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a>                <span class=s2>&quot;TraceHeader&quot;</span><span class=p>:</span> <span class=s2>&quot;carRideProcessing&quot;</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a>                <span class=p>},</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a>            <span class=p>]</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a>    <span class=k>return</span> <span class=n>entries</span>
</span></code></pre></div> <p>This approach supports the event replication used when deploying in two regions, and uses EventBridge Global Endpoint capability:</p> <p><img alt src=../diagrams/eb-duplicate-2-regions-problem.drawio.png></p> <p>If a failover is triggered by Route 53 health check error on the primary event bus, then messages are sent to secondary region, and duplicates can be managed the same way as in a mono-region. Except if dynamoDB is not accessible by itself from the first region. In this case Global Table may be used. </p> <p>For EventBridge configuration here is an example of producer configuration in a SAM template:</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=nt>Resources</span><span class=p>:</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>  </span><span class=nt>CarRideEventBus</span><span class=p>:</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>    </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Events::EventBus</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>    </span><span class=nt>Properties</span><span class=p>:</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>      </span><span class=nt>Name</span><span class=p>:</span><span class=w> </span><span class=kt>!Ref</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">EventBusName</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class="w w-Error"> </span><span class=nt>CarRideSimulatorFunction</span><span class=p>:</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>    </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span><span class=w> </span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>    </span><span class=nt>Properties</span><span class=p>:</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=w>      </span><span class=nt>Environment</span><span class=p>:</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>        </span><span class=nt>Variables</span><span class=p>:</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>          </span><span class=nt>EventBus</span><span class=p>:</span><span class=w> </span><span class=kt>!Ref</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">EventBusName</span><span class=w> </span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=w>    </span><span class=nt>Policies</span><span class=p>:</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>Statement</span><span class=p>:</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>Sid</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">SendEvents</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=w>          </span><span class=nt>Effect</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=w>          </span><span class=nt>Action</span><span class=p>:</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">events:PutEvents</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=w>          </span><span class=nt>Resource</span><span class=p>:</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=kt>!GetAtt</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CarRideEventBus.Arn</span>
</span></code></pre></div> <h2 id=the-consumer-part>The Consumer part<a class=headerlink href=#the-consumer-part title="Permanent link">&para;</a></h2> <p>Only the consumer of the message can identify duplicate records. If the consumer is not using an idempotent backend for persistence, then it needs to track the messages that it has processed in order to detect and discard duplicates. </p> <p>We assume the consumer is looking at the events, from another bounded context, and it is interested to subscribe to the event bus to support its own joining queries or to participate in a long-running transaction. </p> <p>Below is the SAM template illustrating to the CarRides EventBus rule to push to a lambda consumer, using a DLQ in case of issue.</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=nt>CarRidesToConsumerRule</span><span class=p>:</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>    </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Events::Rule</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>    </span><span class=nt>Properties</span><span class=p>:</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=w>      </span><span class=nt>Description</span><span class=p>:</span><span class=w> </span><span class=s>&quot;EventRule</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>move</span><span class=nv> </span><span class=s>CarRides</span><span class=nv> </span><span class=s>transactions</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>Lambda</span><span class=nv> </span><span class=s>Consumer&quot;</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>      </span><span class=nt>EventBusName</span><span class=p>:</span><span class=w> </span><span class=kt>!Ref</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CarRideEventBus</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>      </span><span class=nt>EventPattern</span><span class=p>:</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>        </span><span class=nt>source</span><span class=p>:</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">acr.com.car-ride-simulator</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>        </span><span class=nt>detail-type</span><span class=p>:</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CarRideEvent</span><span class=w> </span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>      </span><span class=nt>State</span><span class=p>:</span><span class=w> </span><span class=s>&quot;ENABLED&quot;</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=w>      </span><span class=nt>Targets</span><span class=p>:</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>Arn</span><span class=p>:</span><span class=w> </span><span class=kt>!GetAtt</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CarRidesConsumerFunction.Arn</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=w>          </span><span class=nt>Id</span><span class=p>:</span><span class=w> </span><span class=s>&quot;CarRidesLambdaConsumer&quot;</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=w>          </span><span class=nt>DeadLetterConfig</span><span class=p>:</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=w>            </span><span class=nt>Arn</span><span class=p>:</span><span class=w>  </span><span class=kt>!GetAtt</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CarRidesDLQQueue.Arn</span>
</span></code></pre></div> <h3 id=dynamodb-backend>DynamoDB backend<a class=headerlink href=#dynamodb-backend title="Permanent link">&para;</a></h3> <p>If the consumer uses DynamoDB as persistence layer then it can use the <a href=https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_UpdateItem.html>updateItem</a> API to edit the existing event's attributes, or use the <a href=https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_GetItem.html>get_items</a> to validate presence of the event and then adds a new event to the table if the event does not already exist. </p> <p><img alt src=../diagrams/consumer.drawio.png width=600></p> <p>The approach is to declare a table using the idempotencyId as a key:</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=w>  </span><span class=nt>CarRideEventsTable</span><span class=p>:</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>    </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::SimpleTable</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>    </span><span class=nt>Properties</span><span class=p>:</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=w>      </span><span class=nt>TableName</span><span class=p>:</span><span class=w> </span><span class=kt>!Ref</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TableName</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=w>      </span><span class=nt>PrimaryKey</span><span class=p>:</span><span class=w> </span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>        </span><span class=nt>Name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">idempotencyId</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=w>        </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">String</span>
</span></code></pre></div> <p>The code then uses something like the following snippet, doing nothing in case of exception</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>  <span class=n>existingEvent</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>  <span class=k>try</span><span class=p>:</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>      <span class=n>response</span> <span class=o>=</span> <span class=n>eventsProcessed</span><span class=o>.</span><span class=n>get_item</span><span class=p>(</span><span class=n>Key</span><span class=o>=</span> <span class=p>{</span><span class=s2>&quot;idempotencyId&quot;</span><span class=p>:</span> <span class=n>idempotencyId</span><span class=p>})</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>      <span class=n>existingEvent</span> <span class=o>=</span> <span class=n>response</span><span class=p>[</span><span class=s2>&quot;Item&quot;</span><span class=p>]</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>  <span class=k>except</span> <span class=n>ClientError</span> <span class=k>as</span> <span class=n>err</span><span class=p>:</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>      <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&quot;Could not find events </span><span class=si>%s</span><span class=s2>&quot;</span><span class=p>,</span><span class=n>idempotencyId</span><span class=p>)</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>  <span class=k>if</span> <span class=n>existingEvent</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>      <span class=c1># call process the new event only if there is no duplicate</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>      <span class=n>processEvent</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>      <span class=n>eventsProcessed</span><span class=o>.</span><span class=n>put_item</span><span class=p>(</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>          <span class=n>Item</span><span class=o>=</span><span class=p>{</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>              <span class=s2>&quot;idempotencyId&quot;</span> <span class=p>:</span> <span class=n>idempotencyId</span><span class=p>,</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>              <span class=s2>&quot;payload&quot;</span><span class=p>:</span> <span class=n>payload</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>          <span class=p>})</span>
</span></code></pre></div> <p>The DynamoDB configuration is mono-region multi AZ for high availability. </p> <h3 id=demonstrate-with-a-simulator>Demonstrate with a simulator<a class=headerlink href=#demonstrate-with-a-simulator title="Permanent link">&para;</a></h3> <p>The <a href=https://gitlab.aws.dev/boyerje/autonomous-car-solution/-/tree/main/CarRideSimulator>code repository</a>, supports the following deployment and instructions to deploy it using <a href=https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html>AWS Serverless Application Management</a></p> <p><img alt src=../diagrams/eb-duplicate-capestone.drawio.png></p> <p>Here is an example of record persisted in the DynamoDB CarRideEvents table, illustrating that <code>eventCount</code> is always 1.</p> <p><img alt src=../diagrams/event-in-dynamoDB.png></p> <h3 id=single-application-instance>Single application instance:<a class=headerlink href=#single-application-instance title="Permanent link">&para;</a></h3> <p>The simplest in memory solution uses a simple HashMap as cache. It may work for an application running continuously, with a single instance. The basic code may look like: </p> <div class="language-python highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=k>def</span><span class=w> </span><span class=nf>lambda_handler</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>    <span class=n>idempotencyId</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s2>&quot;detail&quot;</span><span class=p>][</span><span class=s2>&quot;attributes&quot;</span><span class=p>][</span><span class=s2>&quot;idempotencyId&quot;</span><span class=p>]</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>    <span class=n>payload</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s2>&quot;detail&quot;</span><span class=p>]</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>    <span class=n>existingEvent</span> <span class=o>=</span> <span class=n>eventsProcessed</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>idempotencyId</span><span class=p>)</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>    <span class=k>if</span> <span class=n>existingEvent</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>        <span class=n>processEvent</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>        <span class=n>eventsProcessed</span><span class=p>[</span><span class=n>idempotencyId</span><span class=p>]</span> <span class=o>=</span> <span class=n>payload</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&quot;</span><span class=si>%s</span><span class=s2> most likely duplicate &quot;</span><span class=p>,</span> <span class=n>idempotencyId</span><span class=p>)</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></code></pre></div> <p><a href=https://gitlab.aws.dev/boyerje/autonomous-car-solution/-/blob/main/CarRideSimulator/consumers/app.py>See the code here.</a> and how to run it. </p> <h3 id=using-caching-with-redis>Using Caching with Redis<a class=headerlink href=#using-caching-with-redis title="Permanent link">&para;</a></h3> <p>When we define multiple concurrent instances of the application, like lambda function, we need to use a distributed, clustered data cache like AWS MemoryDB for Redis.</p> <p>At the consumer side before processing a new message, the code checks if the <code>idempotencyId</code> already exists in the cache. If it does, consider it a duplicate and discard it. </p> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>
</span></code></pre></div> <p>The problem is how to evict older events from the cache. A scheduled processing may be used to remove any messages older than to current timestamp - n minutes. The n can be computed by assessing the risk to get a duplicate messages within this time window, and any resource constraints like memory usage.</p> <hr> <h2 id=alternates>Alternates<a class=headerlink href=#alternates title="Permanent link">&para;</a></h2> <h3 id=powertool-for-aws-lambda>Powertool for AWS Lambda<a class=headerlink href=#powertool-for-aws-lambda title="Permanent link">&para;</a></h3> <p><a href=https://docs.powertools.aws.dev/lambda/python/latest/ >Powertools for AWS Lambda (Python)</a> supports idempotency constructs via annotations and persistence into DynamoDB which should help to support idempotency processing inside of a Lambda function. This is a valuable solution. Lambda oriented. To use CloudEvents there is a way to define <code>jmespath</code> to get idempotency key from the json message. </p> <h3 id=use-outbox-pattern>Use Outbox pattern<a class=headerlink href=#use-outbox-pattern title="Permanent link">&para;</a></h3> <p>Another, may be more elegant, implementation is to use the Outbox pattern apply from the producer database, and write the events to a table in DynamoDB, do change data capture on this outbox table, using DynamoDB Streams, use EventBridge pipe to process the streaming data and then to send it to SNS target, to scatter and gather to multiple consumers.</p> <p><img alt src=../diagrams/exactly-once-eb-dynamo.drawio.png width=1000></p> <p>Other considerations:</p> <p>Message Time-To-Live (TTL): Set a Time-To-Live (TTL) value for messages in the queue. If a message remains in the queue beyond its TTL, consider it expired and discard it. This helps prevent the processing of stale or duplicate messages that might have been delayed or requeued due to failures.</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../../techno/mirrormaker/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Mirror Maker 2"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Mirror Maker 2 </div> </div> </a> <a href=../../../ibm-assets/ class="md-footer__link md-footer__link--next" aria-label="Next: IBM Assets"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> IBM Assets </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2018 - 2024 Jerome Boyer </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/jbcodeforce target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://linkedin.com/in/jeromeboyer target=_blank rel=noopener title=linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.8l167.6-182.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../../..", "features": ["content.code.annotate", "content.tooltips", "content.code.copy", "search.highlight", "navigation.instant", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "navigation.instant", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.top", "navigation.footer"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.13a4f30d.min.js></script> <script src=../../../javascripts/mathjax.js></script> <script src=https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>