<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://jeromeboyer.net/eda-studies/patterns/cqrs/ rel=canonical><link href=../event-sourcing/ rel=prev><link href=../reactive/ rel=next><link rel=icon href=../../images/logo-blue.drawio.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.14"><title>CQRS - Event-Driven Solutions in Hybrid Cloud - Jerome Boyer</title><link rel=stylesheet href=../../assets/stylesheets/main.342714a4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#command-query-responsibility-segregation-cqrs class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Event-Driven Solutions in Hybrid Cloud - Jerome Boyer" class="md-header__button md-logo" aria-label="Event-Driven Solutions in Hybrid Cloud - Jerome Boyer" data-md-component=logo> <img src=../../images/logo.drawio.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Event-Driven Solutions in Hybrid Cloud - Jerome Boyer </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> CQRS </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/eda-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../concepts/eda/ class=md-tabs__link> EDA concepts </a> </li> <li class=md-tabs__item> <a href=../../methodology/event-storming/ class=md-tabs__link> Methodology </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../ class=md-tabs__link> Design patterns </a> </li> <li class=md-tabs__item> <a href=../../methodology/getting-started/ class=md-tabs__link> Demonstrations </a> </li> <li class=md-tabs__item> <a href=../../techno/kafka/ class=md-tabs__link> Technologies </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Event-Driven Solutions in Hybrid Cloud - Jerome Boyer" class="md-nav__button md-logo" aria-label="Event-Driven Solutions in Hybrid Cloud - Jerome Boyer" data-md-component=logo> <img src=../../images/logo.drawio.png alt=logo> </a> Event-Driven Solutions in Hybrid Cloud - Jerome Boyer </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/eda-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> EDA concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> EDA concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../concepts/eda/ class=md-nav__link> <span class=md-ellipsis> Reference architecture </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/soa-eda/ class=md-nav__link> <span class=md-ellipsis> From SOA to EDA </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/backbone/ class=md-nav__link> <span class=md-ellipsis> Messaging backbone </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/legacy-itg/ class=md-nav__link> <span class=md-ellipsis> Legacy integration </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/data-pipeline/ class=md-nav__link> <span class=md-ellipsis> Data pipeline </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Methodology </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Methodology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../methodology/event-storming/ class=md-nav__link> <span class=md-ellipsis> Event Storming </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/ddd/ class=md-nav__link> <span class=md-ellipsis> Domain driven design </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/ddd/eda_assessment/ class=md-nav__link> <span class=md-ellipsis> EDA Assessment </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/event-storming/vaccine-dt-es-ddd/ class=md-nav__link> <span class=md-ellipsis> Vaccine Examples </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Design patterns </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Design patterns </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> <span class=md-ellipsis> Common patterns </span> </a> </li> <li class=md-nav__item> <a href=../events-versus-messages/ class=md-nav__link> <span class=md-ellipsis> Messaging vs events </span> </a> </li> <li class=md-nav__item> <a href=../model/ class=md-nav__link> <span class=md-ellipsis> Devising the data models </span> </a> </li> <li class=md-nav__item> <a href=../api-mgt/ class=md-nav__link> <span class=md-ellipsis> API management </span> </a> </li> <li class=md-nav__item> <a href=../saga/ class=md-nav__link> <span class=md-ellipsis> Saga </span> </a> </li> <li class=md-nav__item> <a href=../event-sourcing/ class=md-nav__link> <span class=md-ellipsis> Event Sourcing </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> CQRS </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> CQRS </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#problems-and-constraints class=md-nav__link> <span class=md-ellipsis> Problems and Constraints </span> </a> </li> <li class=md-nav__item> <a href=#solution-and-pattern class=md-nav__link> <span class=md-ellipsis> Solution and Pattern </span> </a> <nav class=md-nav aria-label="Solution and Pattern"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#typical-application-data-access class=md-nav__link> <span class=md-ellipsis> Typical application data access </span> </a> </li> <li class=md-nav__item> <a href=#separate-read-and-write-apis class=md-nav__link> <span class=md-ellipsis> Separate read and write APIs </span> </a> </li> <li class=md-nav__item> <a href=#separate-read-and-write-models class=md-nav__link> <span class=md-ellipsis> Separate read and write models </span> </a> </li> <li class=md-nav__item> <a href=#separate-read-and-write-databases class=md-nav__link> <span class=md-ellipsis> Separate read and write databases </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#considerations class=md-nav__link> <span class=md-ellipsis> Considerations </span> </a> </li> <li class=md-nav__item> <a href=#combining-event-sourcing-and-cqrs class=md-nav__link> <span class=md-ellipsis> Combining event sourcing and CQRS </span> </a> </li> <li class=md-nav__item> <a href=#keeping-the-write-model-on-mainframe class=md-nav__link> <span class=md-ellipsis> Keeping the write model on Mainframe </span> </a> </li> <li class=md-nav__item> <a href=#the-consistency-challenges class=md-nav__link> <span class=md-ellipsis> The consistency challenges </span> </a> <nav class=md-nav aria-label="The consistency challenges"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cqrs-and-change-data-capture class=md-nav__link> <span class=md-ellipsis> CQRS and Change Data Capture </span> </a> </li> <li class=md-nav__item> <a href=#delay-in-the-view class=md-nav__link> <span class=md-ellipsis> Delay in the view </span> </a> </li> <li class=md-nav__item> <a href=#schema-change class=md-nav__link> <span class=md-ellipsis> Schema change </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#further-readings class=md-nav__link> <span class=md-ellipsis> Further readings </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../reactive/ class=md-nav__link> <span class=md-ellipsis> Reactive </span> </a> </li> <li class=md-nav__item> <a href=../flow-architectures/ class=md-nav__link> <span class=md-ellipsis> Flow architecture </span> </a> </li> <li class=md-nav__item> <a href=../dlq/ class=md-nav__link> <span class=md-ellipsis> Dead letter queue </span> </a> </li> <li class=md-nav__item> <a href=../data-lineage/ class=md-nav__link> <span class=md-ellipsis> Data lineage </span> </a> </li> <li class=md-nav__item> <a href=../governance/ class=md-nav__link> <span class=md-ellipsis> Governance </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Demonstrations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Demonstrations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../methodology/getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kafka/playground/ class=md-nav__link> <span class=md-ellipsis> Sandbox notes </span> </a> </li> <li class=md-nav__item> <a href=../../solutions/gitops_IaC/ class=md-nav__link> <span class=md-ellipsis> GitOps - IaC </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/eda-rt-inventory/ class=md-nav__link> <span class=md-ellipsis> Real-time Inventory </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Technologies </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Technologies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../techno/kafka/ class=md-nav__link> <span class=md-ellipsis> Kafka </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kafka/faq/ class=md-nav__link> <span class=md-ellipsis> Kafka FAQ </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kafka/producer/ class=md-nav__link> <span class=md-ellipsis> Kafka Producer </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kafka/consumer/ class=md-nav__link> <span class=md-ellipsis> Kafka Consumer </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kafka/security/ class=md-nav__link> <span class=md-ellipsis> Kafka Security </span> </a> </li> <li class=md-nav__item> <a href=../../techno/avro-schemas/ class=md-nav__link> <span class=md-ellipsis> Schema Mgt </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kstreams/ class=md-nav__link> <span class=md-ellipsis> Kafka Streams </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kafka-connect/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect </span> </a> </li> <li class=md-nav__item> <a href=../../techno/confluent/ class=md-nav__link> <span class=md-ellipsis> Confluent </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/redpanda-studies/ class=md-nav__link> <span class=md-ellipsis> RedPanda </span> </a> </li> <li class=md-nav__item> <a href=../../techno/mirrormaker/ class=md-nav__link> <span class=md-ellipsis> Mirror Maker 2 </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/flink-studies class=md-nav__link> <span class=md-ellipsis> Flink </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study/activemq/ class=md-nav__link> <span class=md-ellipsis> Active MQ </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study/rabbitmq/ class=md-nav__link> <span class=md-ellipsis> Rabbit MQ </span> </a> </li> <li class=md-nav__item> <a href=../../solutions/autonomous-car/es-duplicate-evt/ class=md-nav__link> <span class=md-ellipsis> AWS duplicate with EB </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/yarfba/kinesis class=md-nav__link> <span class=md-ellipsis> AWS Kinesis </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/yarfba/serverless/msk class=md-nav__link> <span class=md-ellipsis> AWS MSK </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study class=md-nav__link> <span class=md-ellipsis> AWS messaging </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study/sqs/ class=md-nav__link> <span class=md-ellipsis> AWS SQS </span> </a> </li> <li class=md-nav__item> <a href=../../ibm-assets/ class=md-nav__link> <span class=md-ellipsis> IBM Assets </span> </a> </li> <li class=md-nav__item> <a href=../../techno/ibm-mq/ class=md-nav__link> <span class=md-ellipsis> IBM MQ </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#problems-and-constraints class=md-nav__link> <span class=md-ellipsis> Problems and Constraints </span> </a> </li> <li class=md-nav__item> <a href=#solution-and-pattern class=md-nav__link> <span class=md-ellipsis> Solution and Pattern </span> </a> <nav class=md-nav aria-label="Solution and Pattern"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#typical-application-data-access class=md-nav__link> <span class=md-ellipsis> Typical application data access </span> </a> </li> <li class=md-nav__item> <a href=#separate-read-and-write-apis class=md-nav__link> <span class=md-ellipsis> Separate read and write APIs </span> </a> </li> <li class=md-nav__item> <a href=#separate-read-and-write-models class=md-nav__link> <span class=md-ellipsis> Separate read and write models </span> </a> </li> <li class=md-nav__item> <a href=#separate-read-and-write-databases class=md-nav__link> <span class=md-ellipsis> Separate read and write databases </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#considerations class=md-nav__link> <span class=md-ellipsis> Considerations </span> </a> </li> <li class=md-nav__item> <a href=#combining-event-sourcing-and-cqrs class=md-nav__link> <span class=md-ellipsis> Combining event sourcing and CQRS </span> </a> </li> <li class=md-nav__item> <a href=#keeping-the-write-model-on-mainframe class=md-nav__link> <span class=md-ellipsis> Keeping the write model on Mainframe </span> </a> </li> <li class=md-nav__item> <a href=#the-consistency-challenges class=md-nav__link> <span class=md-ellipsis> The consistency challenges </span> </a> <nav class=md-nav aria-label="The consistency challenges"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cqrs-and-change-data-capture class=md-nav__link> <span class=md-ellipsis> CQRS and Change Data Capture </span> </a> </li> <li class=md-nav__item> <a href=#delay-in-the-view class=md-nav__link> <span class=md-ellipsis> Delay in the view </span> </a> </li> <li class=md-nav__item> <a href=#schema-change class=md-nav__link> <span class=md-ellipsis> Schema change </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#further-readings class=md-nav__link> <span class=md-ellipsis> Further readings </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=command-query-responsibility-segregation-cqrs>Command-Query Responsibility Segregation (CQRS)<a class=headerlink href=#command-query-responsibility-segregation-cqrs title="Permanent link">&para;</a></h1> <h2 id=problems-and-constraints>Problems and Constraints<a class=headerlink href=#problems-and-constraints title="Permanent link">&para;</a></h2> <p>A domain-model encapsulates domain data with the behavior for maintaining the correctness of that data as it is modified, structuring the data based on how it is stored in the database and to facilitate managing the data. Multiple clients can independently update the data concurrently. Different clients may not use the data the way the domain model structures it, and may not agree with each other on how it should be structured.</p> <p><strong>When a domain model becomes overburdened managing complex aggregate objects, concurrent updates, and numerous cross-cutting views, how can it be refactored to separate different aspects of how the data is used?</strong></p> <p>The primitive data tasks are often expressed as create, read, update, and delete (CRUD); using them is known as CRUDing the data. Application code often does not make much distinction between the tasks; individual operations may mix reading the data with changing the data as needed.</p> <p>This simple approach works well when all clients of the data can use the same structure and contention is low. A single domain model can manage the data, make it accessible as domain objects, and ensure updates maintain its consistency. However, this approach becomes inadaquate when different clients want different views across multiple sets of data, when the data is too widely used, and/or when multiple clients updating the data may unknowlingly conflict with each other.</p> <p>For example, in a microservices architecture, each microservice should store and manage its own business entity, but a user interface may need to display data from several microservices. A query that gathers bits of data from multiple sources can be inefficient (time and bandwidth consumed accessing multiple data sources, CPU consumed to transform data, memory consumed by intermediate objects) and must be repeated each time the data is accessed.</p> <p>Another example is an enterprise database managing data required by multiple applications. It can become overloaded with too many clients needing too many connections to run too many threads performing too many transactions--such that the database becomes a performance bottleneck and can even stop.</p> <p>Another example is maintaining consistency of the data while clients concurrently make independent updates to the data. While each update may be consistent, they may conflict with each other. Database locking ensures that the updates don't change the same data concurrently, but doesn't ensure multiple independent changes result in a consistent data model.</p> <p>When data usage is more complex than a single domain model can facilitate, a more sophisticated approach is needed.</p> <h2 id=solution-and-pattern>Solution and Pattern<a class=headerlink href=#solution-and-pattern title="Permanent link">&para;</a></h2> <p><strong>Refactor a domain model to separate operations for querying data and operations for updating data so that they may be handled independently.</strong></p> <p>The CQRS pattern strictly segregates operations that read data from operations that update data. An operation can read data (the R in CRUD) or can write data (the CUD in CRUD), but not both.</p> <p>This separation can make using data much more manageable in several respects. The read operations and the write operations are simpler to implement because their functionality is more finely focused. The operations can be developed independently, potentially by separate teams. The operations can be optimized independently and can evolve independently, adpating to requirements more easily. These optimized operations can scale better, perform better, and security can be applied more precisely.</p> <p>The full CQRS pattern uses separate read and write databases. In doing so, the pattern segregates not just the APIs for accessing data or the models for managing data, but even segregates the database itself into two, a read/write database that is effectively write-only and one or more read-only databases.</p> <p>The adoption of the pattern can be applied in phases, incrementally from existing code. To illustrate this, we will use four stages that could be used incrementally or selecting the most appropriate stage without considering the others:</p> <ol> <li>Stage 0: <a href=#typical-application-data-access>Typical application data access</a></li> <li>Stage 1: <a href=#separate-read-and-write-apis>Separate read and write APIs</a></li> <li>Stage 2: <a href=#separate-read-and-write-models>Separate read and write models</a></li> <li>Stage 3: <a href=#separate-read-and-write-databases>Separate read and write databases</a></li> </ol> <h3 id=typical-application-data-access>Typical application data access<a class=headerlink href=#typical-application-data-access title="Permanent link">&para;</a></h3> <p>Before even beginning to apply the pattern, let’s consider the typical app design for accessing data. This diagram shows an app with a domain model for accessing data persisted in a database of record, i.e. a single source of truth for that data. The domain model has an API that at a minimum enables clients to perform CRUD tasks on domain objects within the model.</p> <p><img alt=1 src=images/first-rw-model.drawio.png width=200></p> <p>The <a href=https://www.martinfowler.com/eaaCatalog/domainModel.html>domain model</a> is an object representation of the database documents or records. It is comprised of domain objects that represent individual documents or records and the business logic for managing and using them. <a href=https://dddcommunity.org/learning-ddd/what_is_ddd/ >Domain-Driven Design</a> (DDD) models these domain objects as <a href=https://martinfowler.com/bliki/EvansClassification.html>entities</a>—“objects that have a distinct identity that runs through time and different representations”—and <a href=https://martinfowler.com/bliki/DDD_Aggregate.html>aggregates</a>—“a cluster of domain objects that can be treated as a single unit”; the aggregate root maintains the integrity of the aggregate as a whole.</p> <p>Ideally, the domain model’s API should be more domain-specific than simply CRUDing of data. Instead, it should expose higher-level operations that represent business functionality like <code>findCustomer()</code>, <code>placeOrder()</code>, <code>transferFunds()</code>, and so on. These operations read and update data as needed, sometimes doing both in a single operation. They are correct as long as they fit the way the business works.</p> <h3 id=separate-read-and-write-apis>Separate read and write APIs<a class=headerlink href=#separate-read-and-write-apis title="Permanent link">&para;</a></h3> <p>The first and most visible step in applying the CQRS pattern is splitting the CRUD API into separate read and write APIs. This diagram shows the same domain model as before, but its single CRUD API is split into retrieve and modify APIs.</p> <p><img alt=2 src=images/separate-rw-model.drawio.png width=400></p> <p>The two APIs share the existing domain model but split the behavior:</p> <ul> <li><strong>Read</strong>: The retrieve API is used to read the existing state of the objects in the domain model without changing that state. The API treats the domain state as read only.</li> <li><strong>Write</strong>: The modify API is used to change the objects in the domain model. Changes are made using CUD tasks: create new domain objects, update the state in existing ones, and delete ones that are no longer needed. The operations in this API do not return result values, they return success (ack or void) or failure (nak or throw an exception). The create operation might return the primary of key of the entity, which can be generated either by the domain model or in the data store.</li> </ul> <p>This separation of APIs is an application of the <a href=https://martinfowler.com/bliki/CommandQuerySeparation.html>Command Query Separation</a> (CQS) pattern, which says to clearly separate methods that change state from those that don’t. To do so, each of an object’s methods can be in one of two categories (but not both):</p> <ul> <li><strong>Query</strong>: Returns a result, a view of the domain model. Does not change the system’s state nor cause any side effects that change the state.</li> <li><strong>Command</strong> (a.k.a. modifiers or mutators): Changes the state of a system. Does not return a value, just an indication of success or failure.</li> </ul> <p>With this approach, the domain model works the same and provides access to the data the same as before. What has changed is the API for using the domain model. Whereas a higher-level operation might previously have both changed the state of the application and returned a part of that state, now each such operation is redesigned to only do one or the other.</p> <p>When the domain model splits its API into read and write operations, clients using the API must likewise split their functionality into querying and updating functionality. Most new web based applications are based in the single page application, with components and services that use and encapsulate remote API. So this separation of backend API fits well with modern web applications.</p> <p>This stage depends on the domain model being able to implement both the retrieve and modify APIs. A single domain model requires the retrieve and modify behavior to have similar, corresponding implementations. For them to evolve independently, the two APIs will need to be implemented with separate read and write models.</p> <h3 id=separate-read-and-write-models>Separate read and write models<a class=headerlink href=#separate-read-and-write-models title="Permanent link">&para;</a></h3> <p>The second step, in applying the CQRS pattern, is to split the domain model into separate read and write models. This doesn’t just change the API for accessing domain functionality, it also changes the design of how that functionality is structured and implemented. This diagram shows that the domain model becomes the basis for a write model that handles changes to the domain objects, along with a separate read model used to access the state of the application.</p> <p><img alt=3 src=images/separate-rw-model-2.drawio.png width=400></p> <p>Naturally, the read model implements the retrieve API and the write model implements the modify API. Now, the application consists not only of separate APIs for querying and updating the domain objects, there’s also separate business functionality for doing so. Both the read business functionality and the write business functionality share the same database.</p> <p>The write model is implemented by specializing the domain model to focus solely on maintaining the valid structure of domain objects when changing their state and by applying any business rules.</p> <p>Meanwhile, responsibility for returning domain objects is shifted to a separate read model. The read model defines <a href=https://martinfowler.com/eaaCatalog/dataTransferObject.html>Data Transfer Objects</a> (DTOs) designed specifically for the model to return just the data the client wants in a structure the client finds convenient. The read model knows how to gather the data used to populate the DTOs. DTOs encapsulate little if any domain functionality, they just bundle data into a convenient package that can easily be transmitted using a single method call, especially between processes.</p> <p>The read model should be able to implement the retrieve API by implementing the necessary queries and executing them. If the retrieve API is already built to return domain objects as results, the read model can continue to do so, or better yet, implements DTO types that are compatible with the domain objects and returns those. Likewise, the modify API was already implemented using the domain model, so the write model should preserve that. The write model may enhance the implementation to more explicitly implement a command interface or use command objects.</p> <p>This phase assumes that the read and write models can both be implemented using the same database of record the domain model has been using. To the extent this is true, the implementations of reading and writing can evolve independently and be optimized independently. This independence may become increasingly limited since they are both bound to the same database with a single schema or data model. To enable the read and write models to evolve independently, they may each need their own database.</p> <h3 id=separate-read-and-write-databases>Separate read and write databases<a class=headerlink href=#separate-read-and-write-databases title="Permanent link">&para;</a></h3> <p>The third step in applying the CQRS pattern—-which implements the complete CQRS pattern solution—-is splitting the database of record into separate read and write databases. This diagram shows the write model and read model, each supported by its own database. The overall solution consists of two main parts: the write solution that supports updating the data and the read solution that supports querying the data. The two parts are connected by the event bus.</p> <p><img alt=4 src=images/separate-rw-model-full.drawio.png width=600></p> <p>The write model has its own read/write database and the read model has its own read-only database. The read/write database still serves as the database of record (the single source of truth for the data) but is mostly used write-only: mostly written to and rarely read. Reading is offloaded onto a separate read database that contains the same data but is used read-only.</p> <p>The query database is effectively a cache of the database of record, with all of the inherit benefits and complexity of the Caching pattern. The query database contains a copy of the data in the database of record, with the copy structured and staged for easier access by the clients using the retrieve API. As a copy, overhead is needed to keep the copy synchronized with changes in the original. Latency in this synchronization process creates eventual consistency, during which the data copy is stale.</p> <p>The separate databases enable the separate read and write models and their respective retrieve and modify APIs to truly evolve independently. Not only can the read model or write model’s implementation change without changing the other, but how each stores its data can be changed independently.</p> <p>This solution offers the following advantages:</p> <ul> <li><strong>Scaling</strong>: The query load is moved from the write database to the read database. If the database of record is a scalability bottleneck and a lot of the load on it is caused by queries, unloading those query responsibilities can significantly improve the scalability of the combined data access.</li> <li><strong>Performance</strong>: The schemas of the two databases can be different, enabling them to be designed and optimized independently for better performance. The write database can be optimized for data consistency and correctness, with capabilities such as stored procedures that fit the write model and assist with data updates. The read database can store the data in units that better fit the read model and are better optimized for querying, with larger rows requiring fewer joins.</li> </ul> <p>Notice that the design for this stage is significantly more complex than the design for the previous stage. Separate databases with copies of the same data may make data modeling and using data easier, but they require significant overhead to synchronize the data and keep the copies consistent.</p> <p>CQRS employs a couple of design features that support keeping the databases synchronized:</p> <ul> <li><strong>Command Bus for queuing commands</strong> (optional): A more subtle and optional design decision is to queue the commands produced by the modify API, shown in the diagram as the command bus. This can significantly increase the throughput of multiple apps updating the database, as well as serialize updates to help avoid--or at least detect--merge conflicts. With the bus, a client making an update does not block synchronously while the change is written to the database. Rather, the request to change the database is captured as a <a href=https://en.wikipedia.org/wiki/Command_pattern>command</a> (<a href=https://www.pearson.com/us/higher-education/program/Gamma-Design-Patterns-Elements-of-Reusable-Object-Oriented-Software/PGM14333.html><em>Design Patterns</em></a>) and put on a message queue, after which the client can proceed with other work. Asynchronously in the background, the write model processes the commands at the maximum sustainable rate that the database can handle, without the database ever becoming overloaded. If the database becomes temporarily unavailable, the commands queue and will be processed when the database becomes available once more.</li> <li><strong>Event Bus for publishing update events</strong> (required): Whenever the write database is updated, a change notification is published as an event on the event bus. Interested parties can subscribe to the event bus to be notified when the database is updated. One such party is an event processor for the query database, which receives update events and processes them by updating the query database accordingly. In this way, every time the write database is updated, a corresponding update is made to the read database to keep it in sync.</li> </ul> <p>The connection between the command bus and the event bus is facilitated by an application of the <a href=../event-sourcing/ >Event Sourcing pattern</a>, which keeps a change log that is suitable for publishing. Event sourcing maintains not only the current state of the data but also the history of how that current state was reached. For each command on the command bus, the write model performs these tasks to process the command:</p> <ul> <li>Logs the change</li> <li>Updates the database with the change</li> <li>Creates an update event describing the change and publishes it to the event bus</li> </ul> <p>The changes that are logged can be the commands from the command bus or the update events published to the event bus</p> <h2 id=considerations>Considerations<a class=headerlink href=#considerations title="Permanent link">&para;</a></h2> <p>Keep these decisions in mind while applying this pattern:</p> <ul> <li><strong>Client impact</strong>: Applying CQRS not only changes how data is stored and accessed, but also changes the APIs that clients use to access data. This means that each client must be redesigned to use the new APIs.</li> <li><strong>Riskiness</strong>: A lot of the complexity of the pattern solution involves duplicating the data in two databases and keeping them synchronized. Risk comes from querying data that is stale or downright wrong because of problems with the synchronization.</li> <li><strong>Eventual consistency</strong>: Clients querying data must expect that updates will have latency. In a microservices architecture, eventual data consistency is a given and acceptable in many of cases.</li> <li><strong>Command queuing</strong>: Using a command bus as part of the write solution to queue the commands is optional but powerful. In addition to the benefits of queuing, the command objects can easily be stored in the change log and easily be converted into notification events. (In the next section, we illustrate a way to use event bus to queue commands as well.)</li> <li><strong>Change log</strong>: The log of changes to the database of record can be either the list of commands from the command bus or the list of event notifications published on the event bus. The Event Sourcing pattern assumes it’s a log of events, but that pattern doesn’t include the command bus. An event list may be easier to scan as a history, whereas a command list is easier to replay.</li> <li><strong>Create keys</strong>: Strick interpretation of the Command Query Separation (CQS) pattern says that command operations do not have return types. A possible exception is commands that create data: An operation that creates a new record or document typically returns the key for accessing the new data, which is convenient for the client. However, if the create operation is invoked asynchronously by a command on a command bus, the write model will need to perform a callback on the client to return the key.</li> <li><strong>Messaging queues and topics</strong>: While messaging is used to implement both the command bus and event bus, the two busses use messaging differently. The command bus guarantees exactly once delivery. The event bus broadcasts each event to all interested event processors.</li> <li><strong>Query database persistence</strong>: The database of record is always persistent. The query database is a cache that can be a persistent cache or an in-memory cache. If the cache is in-memory and is lost, it must be rebuilt completely from the database of record.</li> <li><strong>Security</strong>: Controls on reading data and updating data can be applied separately using the two parts of the solution.</li> </ul> <h2 id=combining-event-sourcing-and-cqrs>Combining event sourcing and CQRS<a class=headerlink href=#combining-event-sourcing-and-cqrs title="Permanent link">&para;</a></h2> <p>The CQRS application pattern is frequently associated with event sourcing: when doing event sourcing and domain driven design, we event source the aggregates or root entities. Aggregate creates events that are persisted. On top of the simple create, update and read by ID operations, the business requirements want to perform complex queries that can't be answered by a single aggregate. By just using event sourcing to be able to respond to a query like "what are the orders of a customer", then we have to rebuild the history of all orders and filter per customer. It is a lot of computation. This is linked to the problem of having conflicting domain models between query and persistence.</p> <p>As introduced in previous section, creations and updates are done as state notification events (change of state), and are persisted in the event log/store. The following figure, presents two separate microservices, one supporting the write model, and multiple other supporting the queries:</p> <p><img alt=5 src=images/cqrs-es-api.drawio.png width=600></p> <p>The query part is separate processes that consume change log events and build a projection for future queries. The "write" part may persist in SQL while the read may use document oriented database with strong indexing and query capabilities. Or use in-memory database, or distributed cache... They do not need to be in the same language. With CQRS and ES the projections are retroactives. New query equals implementing new projection and read the events from the beginning of time or the recent committed state and snapshot. Read and write models are strongly decoupled and can evolve independently. It is important to note that the 'Command' part can still handle simple queries, primary-key based, like get order by id, or queries that do not involve joins.</p> <p>The event backbone, uses a pub/sub model, to share events to different consumers interested in them.</p> <p>With this structure, the <code>Read model</code> microservice will most likely consume events from multiple topics to build the data projection based on joining those data streams. A query, to assess if the cold-chain was respected on the fresh food order shipment, will go to the <code>voyage</code>, container <code>metrics</code>, and <code>order</code> topics to be able to answer this question. This is where CQRS shines.</p> <p>We can note that, we can separate the API definition and management in a API gateway.</p> <p>Some implementation items to consider:</p> <ul> <li><strong>Consistency</strong> (ensure the data constraints are respected for each data transaction): CQRS without event sourcing has the same consistency guarantees as the database used to persist data and events. With Event Sourcing the consistency could be different, one for the write model and one for the read model. On write model, strong consistency is important to ensure the current state of the system is correct, so it leverages transaction, lock and sharding. On read side, we need less consistency, as they mostly work on stale data. Locking data on the read operation is not reasonable.</li> <li><strong>Scalability</strong>: Separating read and write as two different microservices allows for high availability. Caching at the read level can be used to increase performance response time, and can be deployed as multiple standalone instances (Pods in Kubernetes). It is also possible to separate the query implementations between different services. Functions as service / serverless are good technology choices to implement complex queries.</li> <li><strong>Availability</strong>: The write model sacrafices consistency for availability. This is a fact. The read model is eventually consistent so high availability is possible. In case of failure the system disables the writing of data but still is able to read them as they are served by different databases and services.</li> </ul> <p>With CQRS, the write model can evolve over time without impacting the read model, as long as the event model doesn't change. The read model requires additional tables, but they are often simpler and easier to understand.</p> <p>CQRS results in an increased number of objects, with commands, operations, events,... and packaging in deployable components or containers. It adds potentially different type of data sources. It is more complex.</p> <p>Some challenges to always consider:</p> <ul> <li>How to support event structure version management?</li> <li>How much data to keep in the event store (history)?</li> <li>How to adopt data duplication which results to eventual data consistency?.</li> </ul> <p>The CQRS pattern was introduced by Greg Young:</p> <p><img alt=type:video src=https://www.youtube.com/embed/JHGkaShoyNs></p> <p>and described in <a href=https://martinfowler.com/bliki/CQRS.html>Martin Fowler's work on microservices.</a></p> <p>As you can see in previous figure, as soon as we see two arrows from the same component, we have to ask ourselves how does it work: the write model has to persist <code>Order</code> in its own database and then sends <code>OrderCreated</code> event to the topic... Should those operations be atomic and controlled with transaction? We detail this in next section.</p> <h2 id=keeping-the-write-model-on-mainframe>Keeping the write model on Mainframe<a class=headerlink href=#keeping-the-write-model-on-mainframe title="Permanent link">&para;</a></h2> <p>A lot of transactional systems are based on Mainframe computers. It is very important to note that the system of records and transaction processing is still easier to run on mainframe to support strong consistency. But with the move to cloud native development, it does not mean we have to move all the system of records to the cloud. Data pipelines can be put in place, but CQRS should help by keeping the write model on the current system of records and without impacting the current MIPS utilization move data in the eventual consistency workd of the cloud native, distributed computing world.</p> <p><img alt src=images/cqrs-mainframe.png width=600></p> <p>In the figure above, the write model follows the current transaction processing on the mainframce, change data capture pushes data to Event backbone for getting real-time visibility into the distributed world. The read is the costly operation, dues to the joins to be done to build the projection views needed to expose data depending of the business use cases. This applies with distributed microservices. All the write operations for the business entities kept in the mainframe's system of records are still done via the transaction. </p> <p>Reference data can be injected in one load job to topic and persisted in the event store so streaming applications can leverage them by joining with transactional data. </p> <h2 id=the-consistency-challenges>The consistency challenges<a class=headerlink href=#the-consistency-challenges title="Permanent link">&para;</a></h2> <p>As introduced in the previous section, there is a potential problem of data inconsistency: once a command saves changes into the database, the consumers do not see the new or updated data until event notification completes processing.</p> <p>With traditional Java service, using JPA and JMS, the save and send operations can be part of the same XA transaction and both succeed or fail.</p> <p>With event sourcing pattern, the source of trust is the event source, which acts as a version control system, as shown in the diagram below.</p> <p><img alt=6 src=images/cqrs-es-error-handling.png></p> <p>The steps for synchronizing changes to the data are:</p> <ol> <li>The write model creates the event and publishes it.</li> <li>The consumer receives the event and extracts its payload.</li> <li>The consumer updates its local datasource with the payload data.</li> <li>If the consumer fails to process the update, it can persist the event to an error log or dead letter queue.</li> <li>Each error in the log can be replayed.</li> <li>A command line interface replays an event via an admin API, which searches in the topic using this order id to replay the save operation</li> </ol> <p>This implementation causes a problem for the <code>createOrder(order): string</code> operation: The Order Service is supposed to return the new order completed event with the order id that is a unique key, a key most likely created by the database. If updating the database fails, there is no new order yet and so no database key to use as the order ID. To avoid this problem, if the underlying technology supports assigning the new order's key, the service can generate the order ID and uses that as the order's key in the database.</p> <h3 id=cqrs-and-change-data-capture>CQRS and Change Data Capture<a class=headerlink href=#cqrs-and-change-data-capture title="Permanent link">&para;</a></h3> <p>There are other ways to support this dual operations level:</p> <ul> <li>When using Kafka, <a href=https://kafka.apache.org/documentation/#connect>Kafka Connect</a> has the capability to subscribe to databases via JDBC, allowing to poll tables for updates and then produce events to Kafka.</li> <li>There is an open-source change data capture solution based on extracting change events from database transaction logs, <a href=https://debezium.io/ >Debezium</a> that helps to respond to insert, update and delete operations on databases and generate events accordingly. It supports databases like MySQL, Postgres, MongoDB and others.</li> <li>Write the order to the database and in the same transaction write to an event table (<a href=../#transactional-outbox>"transactional outbox pattern"</a>). Then use a polling to get the events to send to Kafka from this event table and delete the row in the table once the event is sent.</li> <li>Use the Change Data Capture from the database transaction log and generate events from this log. </li> </ul> <p>The CQRS implementation using CDC will look like in the following diagram:</p> <p><img alt src=images/cqrs-cdc.png></p> <p>What is important to note is that the event needs to be flexible on the data payload. </p> <p>On the view side, updates to the view part need to be idempotent.</p> <h3 id=delay-in-the-view>Delay in the view<a class=headerlink href=#delay-in-the-view title="Permanent link">&para;</a></h3> <p>There is a delay between the data persistence and the availability of the data in the Read model. For most business applications, it is perfectly acceptable. In web based data access most of the data are at stale.</p> <p>When there is a need for the client, calling the query operation, to know if the data is up-to-date, the service can define a versioning strategy. When the order data was entered in a form within a single page application, the "create order" operation should return the order with its unique key freshly created and the Single Page Application will have the last data. Here is an example of such operation:</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=nd>@POST</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=kd>public</span><span class=w> </span><span class=n>Response</span><span class=w> </span><span class=nf>create</span><span class=p>(</span><span class=n>OrderCreate</span><span class=w> </span><span class=n>dto</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>    </span><span class=n>Order</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Order</span><span class=p>(</span><span class=n>UUID</span><span class=p>.</span><span class=na>randomUUID</span><span class=p>().</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=n>dto</span><span class=p>.</span><span class=na>getProductID</span><span class=p>(),...);</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>Response</span><span class=p>.</span><span class=na>ok</span><span class=p>().</span><span class=na>entity</span><span class=p>(</span><span class=n>order</span><span class=p>).</span><span class=na>build</span><span class=p>()</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=p>}</span>
</span></code></pre></div> <h3 id=schema-change>Schema change<a class=headerlink href=#schema-change title="Permanent link">&para;</a></h3> <p>What to do when we need to add attribute to event?. So we need to create a versioninig schema for event structure. You need to use flexible schema like json schema, <a href=https://avro.apache.org/docs/current/ >Apache Avro</a> or <a href=https://developers.google.com/protocol-buffers/ >protocol buffer</a> and may be, add an event adapter (as a function?) to translate between the different event structures.</p> <h2 id=further-readings>Further readings<a class=headerlink href=#further-readings title="Permanent link">&para;</a></h2> <ul> <li><a href=https://www.codeproject.com/Articles/555855/Introduction-to-CQRS>https://www.codeproject.com/Articles/555855/Introduction-to-CQRS</a></li> <li><a href=http://udidahan.com/2009/12/09/clarified-cqrs/ >http://udidahan.com/2009/12/09/clarified-cqrs</a></li> <li><a href=https://martinfowler.com/bliki/CQRS.html>https://martinfowler.com/bliki/CQRS.html</a></li> <li><a href=https://microservices.io/patterns/data/cqrs.html>https://microservices.io/patterns/data/cqrs.html</a></li> <li><a href=https://community.risingstack.com/when-to-use-cqrs>https://community.risingstack.com/when-to-use-cqrs</a></li> <li><a href=https://dzone.com/articles/concepts-of-cqrs>https://dzone.com/articles/concepts-of-cqrs</a></li> <li><a href=https://martinfowler.com/bliki/CommandQuerySeparation.html>https://martinfowler.com/bliki/CommandQuerySeparation.html</a></li> <li><a href=https://www.martinfowler.com/eaaCatalog/domainModel.html>https://www.martinfowler.com/eaaCatalog/domainModel.html</a></li> <li><a href=https://dddcommunity.org/learning-ddd/what_is_ddd/ >https://dddcommunity.org/learning-ddd/what_is_ddd/</a></li> <li><a href=https://martinfowler.com/bliki/EvansClassification.html>https://martinfowler.com/bliki/EvansClassification.html</a></li> <li><a href=https://martinfowler.com/bliki/DDD_Aggregate.html>https://martinfowler.com/bliki/DDD_Aggregate.html</a></li> <li><a href=https://martinfowler.com/eaaCatalog/dataTransferObject.html>https://martinfowler.com/eaaCatalog/dataTransferObject.html</a></li> <li><a href=https://en.wikipedia.org/wiki/Command_pattern>https://en.wikipedia.org/wiki/Command_pattern</a></li> <li><a href=https://www.pearson.com/us/higher-education/program/Gamma-Design-Patterns-Elements-of-Reusable-Object-Oriented-Software/PGM14333.html>https://www.pearson.com/us/higher-education/program/Gamma-Design-Patterns-Elements-of-Reusable-Object-Oriented-Software/PGM14333.html</a></li> </ul> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../event-sourcing/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Event Sourcing"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Event Sourcing </div> </div> </a> <a href=../reactive/ class="md-footer__link md-footer__link--next" aria-label="Next: Reactive"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Reactive </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2018 - 2024 Jerome Boyer </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/jbcodeforce target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://linkedin.com/in/jeromeboyer target=_blank rel=noopener title=linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.8l167.6-182.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.annotate", "content.tooltips", "content.code.copy", "search.highlight", "navigation.instant", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "navigation.instant", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.top", "navigation.footer"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.13a4f30d.min.js></script> <script src=../../javascripts/mathjax.js></script> <script src=https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>