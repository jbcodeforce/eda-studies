<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://jeromeboyer.net/eda-studies/patterns/saga/ rel=canonical><link href=../api-mgt/ rel=prev><link href=../event-sourcing/ rel=next><link rel=icon href=../../images/logo-blue.drawio.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.14"><title>Saga - Event-Driven Solutions in Hybrid Cloud - Jerome Boyer</title><link rel=stylesheet href=../../assets/stylesheets/main.342714a4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#saga-long-running-transaction-for-distributed-systems class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Event-Driven Solutions in Hybrid Cloud - Jerome Boyer" class="md-header__button md-logo" aria-label="Event-Driven Solutions in Hybrid Cloud - Jerome Boyer" data-md-component=logo> <img src=../../images/logo.drawio.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Event-Driven Solutions in Hybrid Cloud - Jerome Boyer </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Saga </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/eda-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../concepts/eda/ class=md-tabs__link> EDA concepts </a> </li> <li class=md-tabs__item> <a href=../../methodology/event-storming/ class=md-tabs__link> Methodology </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../ class=md-tabs__link> Design patterns </a> </li> <li class=md-tabs__item> <a href=../../methodology/getting-started/ class=md-tabs__link> Demonstrations </a> </li> <li class=md-tabs__item> <a href=../../techno/kafka/ class=md-tabs__link> Technologies </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Event-Driven Solutions in Hybrid Cloud - Jerome Boyer" class="md-nav__button md-logo" aria-label="Event-Driven Solutions in Hybrid Cloud - Jerome Boyer" data-md-component=logo> <img src=../../images/logo.drawio.png alt=logo> </a> Event-Driven Solutions in Hybrid Cloud - Jerome Boyer </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/eda-studies.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> EDA concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> EDA concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../concepts/eda/ class=md-nav__link> <span class=md-ellipsis> Reference architecture </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/soa-eda/ class=md-nav__link> <span class=md-ellipsis> From SOA to EDA </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/backbone/ class=md-nav__link> <span class=md-ellipsis> Messaging backbone </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/legacy-itg/ class=md-nav__link> <span class=md-ellipsis> Legacy integration </span> </a> </li> <li class=md-nav__item> <a href=../../concepts/data-pipeline/ class=md-nav__link> <span class=md-ellipsis> Data pipeline </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Methodology </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Methodology </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../methodology/event-storming/ class=md-nav__link> <span class=md-ellipsis> Event Storming </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/ddd/ class=md-nav__link> <span class=md-ellipsis> Domain driven design </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/ddd/eda_assessment/ class=md-nav__link> <span class=md-ellipsis> EDA Assessment </span> </a> </li> <li class=md-nav__item> <a href=../../methodology/event-storming/vaccine-dt-es-ddd/ class=md-nav__link> <span class=md-ellipsis> Vaccine Examples </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Design patterns </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Design patterns </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> <span class=md-ellipsis> Common patterns </span> </a> </li> <li class=md-nav__item> <a href=../events-versus-messages/ class=md-nav__link> <span class=md-ellipsis> Messaging vs events </span> </a> </li> <li class=md-nav__item> <a href=../model/ class=md-nav__link> <span class=md-ellipsis> Devising the data models </span> </a> </li> <li class=md-nav__item> <a href=../api-mgt/ class=md-nav__link> <span class=md-ellipsis> API management </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Saga </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Saga </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#problems-and-constraints class=md-nav__link> <span class=md-ellipsis> Problems and Constraints </span> </a> </li> <li class=md-nav__item> <a href=#solution-and-pattern class=md-nav__link> <span class=md-ellipsis> Solution and Pattern </span> </a> </li> <li class=md-nav__item> <a href=#services-choreography class=md-nav__link> <span class=md-ellipsis> Services choreography </span> </a> </li> <li class=md-nav__item> <a href=#services-orchestration class=md-nav__link> <span class=md-ellipsis> Services orchestration </span> </a> </li> <li class=md-nav__item> <a href=#repositories-to-demonstrate-the-saga-patterns class=md-nav__link> <span class=md-ellipsis> Repositories to demonstrate the Saga patterns </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../event-sourcing/ class=md-nav__link> <span class=md-ellipsis> Event Sourcing </span> </a> </li> <li class=md-nav__item> <a href=../cqrs/ class=md-nav__link> <span class=md-ellipsis> CQRS </span> </a> </li> <li class=md-nav__item> <a href=../reactive/ class=md-nav__link> <span class=md-ellipsis> Reactive </span> </a> </li> <li class=md-nav__item> <a href=../flow-architectures/ class=md-nav__link> <span class=md-ellipsis> Flow architecture </span> </a> </li> <li class=md-nav__item> <a href=../dlq/ class=md-nav__link> <span class=md-ellipsis> Dead letter queue </span> </a> </li> <li class=md-nav__item> <a href=../data-lineage/ class=md-nav__link> <span class=md-ellipsis> Data lineage </span> </a> </li> <li class=md-nav__item> <a href=../governance/ class=md-nav__link> <span class=md-ellipsis> Governance </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Demonstrations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Demonstrations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../methodology/getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kafka/playground/ class=md-nav__link> <span class=md-ellipsis> Sandbox notes </span> </a> </li> <li class=md-nav__item> <a href=../../solutions/gitops_IaC/ class=md-nav__link> <span class=md-ellipsis> GitOps - IaC </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/eda-rt-inventory/ class=md-nav__link> <span class=md-ellipsis> Real-time Inventory </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Technologies </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Technologies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../techno/kafka/ class=md-nav__link> <span class=md-ellipsis> Kafka </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kafka/faq/ class=md-nav__link> <span class=md-ellipsis> Kafka FAQ </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kafka/producer/ class=md-nav__link> <span class=md-ellipsis> Kafka Producer </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kafka/consumer/ class=md-nav__link> <span class=md-ellipsis> Kafka Consumer </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kafka/security/ class=md-nav__link> <span class=md-ellipsis> Kafka Security </span> </a> </li> <li class=md-nav__item> <a href=../../techno/avro-schemas/ class=md-nav__link> <span class=md-ellipsis> Schema Mgt </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kstreams/ class=md-nav__link> <span class=md-ellipsis> Kafka Streams </span> </a> </li> <li class=md-nav__item> <a href=../../techno/kafka-connect/ class=md-nav__link> <span class=md-ellipsis> Kafka Connect </span> </a> </li> <li class=md-nav__item> <a href=../../techno/confluent/ class=md-nav__link> <span class=md-ellipsis> Confluent </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/redpanda-studies/ class=md-nav__link> <span class=md-ellipsis> RedPanda </span> </a> </li> <li class=md-nav__item> <a href=../../techno/mirrormaker/ class=md-nav__link> <span class=md-ellipsis> Mirror Maker 2 </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/flink-studies class=md-nav__link> <span class=md-ellipsis> Flink </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study/activemq/ class=md-nav__link> <span class=md-ellipsis> Active MQ </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study/rabbitmq/ class=md-nav__link> <span class=md-ellipsis> Rabbit MQ </span> </a> </li> <li class=md-nav__item> <a href=../../solutions/autonomous-car/es-duplicate-evt/ class=md-nav__link> <span class=md-ellipsis> AWS duplicate with EB </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/yarfba/kinesis class=md-nav__link> <span class=md-ellipsis> AWS Kinesis </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/yarfba/serverless/msk class=md-nav__link> <span class=md-ellipsis> AWS MSK </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study class=md-nav__link> <span class=md-ellipsis> AWS messaging </span> </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-messaging-study/sqs/ class=md-nav__link> <span class=md-ellipsis> AWS SQS </span> </a> </li> <li class=md-nav__item> <a href=../../ibm-assets/ class=md-nav__link> <span class=md-ellipsis> IBM Assets </span> </a> </li> <li class=md-nav__item> <a href=../../techno/ibm-mq/ class=md-nav__link> <span class=md-ellipsis> IBM MQ </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#problems-and-constraints class=md-nav__link> <span class=md-ellipsis> Problems and Constraints </span> </a> </li> <li class=md-nav__item> <a href=#solution-and-pattern class=md-nav__link> <span class=md-ellipsis> Solution and Pattern </span> </a> </li> <li class=md-nav__item> <a href=#services-choreography class=md-nav__link> <span class=md-ellipsis> Services choreography </span> </a> </li> <li class=md-nav__item> <a href=#services-orchestration class=md-nav__link> <span class=md-ellipsis> Services orchestration </span> </a> </li> <li class=md-nav__item> <a href=#repositories-to-demonstrate-the-saga-patterns class=md-nav__link> <span class=md-ellipsis> Repositories to demonstrate the Saga patterns </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=saga-long-running-transaction-for-distributed-systems>Saga: long running transaction for distributed systems<a class=headerlink href=#saga-long-running-transaction-for-distributed-systems title="Permanent link">&para;</a></h1> <h2 id=problems-and-constraints>Problems and Constraints<a class=headerlink href=#problems-and-constraints title="Permanent link">&para;</a></h2> <p>With the adoption of one data source per microservice, there is an interesting challenge on how to support long running transaction cross microservices, which are per nature, distributed. With event backbone technology two-phase commit is not an option.</p> <h2 id=solution-and-pattern>Solution and Pattern<a class=headerlink href=#solution-and-pattern title="Permanent link">&para;</a></h2> <p>Introduced in 1987 <a href=https://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf>by Hector Garcaa-Molrna Kenneth Salem paper</a> the Saga pattern helps to support a long running transaction that can be broken up to a collection of sub transactions that can be interleaved any way with other transactions.</p> <p>With microservice each transaction updates data within a single service, each subsequent steps may be triggered by previous completion. The following figure illustrates the happy path for a CarRide order transaction where each services are participant of the transaction:</p> <p><img alt=1 src=images/saga-ctx.drawio.png width=800></p> <p>When the car ride order is created, the business process says, we need to compute an ETA for arrival at destination. ETA is computed by looking at the closest autonomous car from the pickup location. We suppose the customer accept the ETA notification, and <code>CarManager</code> allocates one "autonomous car". The process continues when the traveler(s) reaches destination,the CarRideManager complete the <code>CarRide</code>, and the event is processed by the PaymentService to initiated the payment, the car goes back to the pool and ride rating is initiated (not illustrated in the flow). </p> <p>Those actions / commands are chained. The final state (in this schema, not in the reality, as the process may have more steps) is the <code>CarRide</code> is in completed state in the <code>CarRide</code> Manager microservice.</p> <p>With a monolytic application, the consistency integrity between CarRide, Car, Customer and Payment tables will be done via transactions. But with distributed systems we could not easily apply strong two-phase commit transactions, this is where the Saga pattern helps to keep context to the conversation and be able to compensate in case of failure.</p> <p>SAGA pattern supports two types of implementation: Choreography and Orchestration.</p> <h2 id=services-choreography>Services choreography<a class=headerlink href=#services-choreography title="Permanent link">&para;</a></h2> <p>With Choreography each service produces and listens to other service’s events and decides, from the event content, if an action should be taken or not. As we talked about events, we will use an event bus to asynchronously exchange messages between the distributed components. From the previous example we do not need the autonomous car events as they most likely being aggregated by the CarManager service:</p> <p><img alt=2 src=images/saga-choreo.drawio.png></p> <p>The traveler is using a mobile application, and defines where he wants the pickup, at what time, and for which destination. In the diagram above events are in orange, commands are in yellow.</p> <p>The first service, <code>CarRideManager</code>, executes a transaction to its own data store and then publishes an event ( <code>CarRideOrderCreated</code> event (1)) as a fact about its business entity (CarRide) update. It maintains the business entity status, (CarRide.status) to the <code>Pending</code> state until the saga is completed. This event is listened by one or more services which execute local transaction and publish new events (CarDispatched (2), CarInMotion, CustomerNotified (3), PaymentProcessed (4)).</p> <p>The distributed transaction ends when the last service executes its local transaction and publishes a confirmation event. The main entity interested by the Saga manages its state accordingly. Here the CarRide is this entity. When one of the service does not publish any event within an expected time, or publish a negative state (PaymentNotCompleted, CarNoMoreDispatched) the Saga should trigger a compensation. </p> <p>In case of failure, the source microservice is keeping state and timer to monitor for the expected completion events. Supposes the customer never acts when he/she receives the notification for payment, the car dispatching is already done so it is not idempotent, a compensation logic may be to route the transaction to a call center so they can reach by sms and phone call the customer. May be the contract stipulates that there will be a charge done anyway as credit card information exists on the account. Now if the failure comes from the payment processing, again a specific compensation process will trigger to get the payment completed. </p> <p><img alt=3 src=images/saga-choreo-fail.drawio.png></p> <p>In the diagram above we suppose When a message from any service is missing, the source service, needs to trigger a compensation process:</p> <p><img alt=4 src=images/saga-choreo-comp.drawio.png></p> <p>Rolling back a distributed transaction does not come for free. Normally you have to implement another operation/transaction to compensate for what has been done before. This will be a new event sent by the service responsible of the transaction integrity. In the CarRide example, in the rare case where one of the service is not able to provide a positive response, then the CarRide needs to change to 'Uncompleted' status, and an event to the CarRides topic will claim the orderID is now uncompleted (OrderUncompleted event Step 1 above). Another classical business flow is the order, payment and fullfilment flow, where failure to pay impact fullfilment step. Any service that has something allocated for this orderId will 'unroll' their changes in their own data source (Steps 2,3,4 above).</p> <p>Also it is important to note, that if one of the service is taking time to answer this may not be a problem as the CarRideOrder is in pending state. If the business requirement stipulates to address an order within a small time period then the compensation process may start. Uncompleted orders can be reviewed by a business user for manual handling. Email can be automatically sent to the customer about issue related to his order. There are a lot of different ways to handle order issue at the business level.</p> <h2 id=services-orchestration>Services orchestration<a class=headerlink href=#services-orchestration title="Permanent link">&para;</a></h2> <p>With orchestration, one service is responsible to drive each participant on what to do and when. This orchestration can be done with different tools and protocols. Workflow engine with synchronous calls, is a classical implementation in the SOA world. There are library supporting long running transaction like the Java<br> With EDA, we do not want to loose any message as part of this orchestration, the technology of choice, to support stronger consistency and exactly once delivery, is to use queueing system with persistence, as illustrated by the following figure:</p> <p><img alt="Saga with Queueing" src=images/saga-orchestration.drawio.png></p> <p>The pattern uses the req/res queues for each service participating into the Saga. The message may be typed and structured to map different commands. </p> <p>For that purpose we are no more in the Event world, but more on the commands supported by asynchronous messaging system.</p> <p>In the Kafka world, we can use topic configuration to represent the queue semantic: Kafka producer uses full acknowledge to be sure no message lost, idempotency to avoid duplicate at the broker level, and a batch size of 1. For the topic configuration, use one partition, one consumer in each consumer group, manual commit, poll one message at a time. The pattern implementation uses the different topics to control the Saga by issuing command messages to the different service. It uses the event backbone as a queue processing to support the asynchronous invocations. Each participant produces response in their context and to the order topic. The orchestration layer needs to keep a state machine and acts once all the expected responses are received.</p> <p>If anything fails, the orchestrator is also responsible for coordinating the compensation process by sending rollback events with orderID and their respective impacted entity key. Each participant will undo its previous operations. Orchestrator is a State Machine where each transformation corresponds to a command or message.</p> <p>See also <a href=https://microservices.io/patterns/data/saga.html>this article</a> from Chris Richardson on the Saga pattern.</p> <h2 id=repositories-to-demonstrate-the-saga-patterns>Repositories to demonstrate the Saga patterns<a class=headerlink href=#repositories-to-demonstrate-the-saga-patterns title="Permanent link">&para;</a></h2> <ul> <li><a href=https://jbcodeforce.github.io/saga-choreography-kafka/ >Saga choerography implementation with Kafka</a></li> <li><a href>Saga orchestration on top of queueing (AWS SQS)</a></li> </ul> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../api-mgt/ class="md-footer__link md-footer__link--prev" aria-label="Previous: API management"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> API management </div> </div> </a> <a href=../event-sourcing/ class="md-footer__link md-footer__link--next" aria-label="Next: Event Sourcing"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Event Sourcing </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2018 - 2024 Jerome Boyer </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/jbcodeforce target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://linkedin.com/in/jeromeboyer target=_blank rel=noopener title=linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.8l167.6-182.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.annotate", "content.tooltips", "content.code.copy", "search.highlight", "navigation.instant", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "navigation.instant", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.top", "navigation.footer"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.13a4f30d.min.js></script> <script src=../../javascripts/mathjax.js></script> <script src=https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>